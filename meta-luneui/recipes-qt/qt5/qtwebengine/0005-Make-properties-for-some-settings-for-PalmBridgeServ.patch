From 86460c59f731e4830fa86ef9ff452afd9783c7ff Mon Sep 17 00:00:00 2001
From: Christophe Chapuis <chris.chapuis@gmail.com>
Date: Wed, 30 Sep 2015 23:37:44 +0200
Subject: [PATCH] Make properties for some settings for PalmBridgeService
 management

Signed-off-by: Christophe Chapuis <chris.chapuis@gmail.com>
---
 src/core/web_engine_settings.cpp              | 19 ++++++++++++++
 src/core/web_engine_settings.h                |  8 +++++-
 src/webengine/api/qquickwebenginesettings.cpp | 38 +++++++++++++++++++++++++++
 src/webengine/api/qquickwebenginesettings_p.h | 12 +++++++++
 4 files changed, 76 insertions(+), 1 deletion(-)

diff --git a/src/core/web_engine_settings.cpp b/src/core/web_engine_settings.cpp
index 19af6b8..57ccca5 100644
--- a/src/core/web_engine_settings.cpp
+++ b/src/core/web_engine_settings.cpp
@@ -212,6 +212,19 @@ QString WebEngineSettings::defaultTextEncoding() const
     return m_defaultEncoding.isEmpty()? parentSettings->defaultTextEncoding() : m_defaultEncoding;
 }
 
+void WebEngineSettings::setLuneOSIdentifier(const QString &identifier)
+{
+    m_luneOSIdentifier = identifier;
+    scheduleApplyRecursively();
+}
+
+QString WebEngineSettings::luneOSIdentifier() const
+{
+    if (!parentSettings)
+        return m_luneOSIdentifier;
+    return m_luneOSIdentifier.isEmpty()? parentSettings->luneOSIdentifier() : m_luneOSIdentifier;
+}
+
 void WebEngineSettings::initDefaults()
 {
     if (s_defaultAttributes.isEmpty()) {
@@ -253,6 +266,8 @@ void WebEngineSettings::initDefaults()
         s_defaultAttributes.insert(AllowRunningInsecureContent, allowRunningInsecureContent);
         s_defaultAttributes.insert(AllowGeolocationOnInsecureOrigins, false);
         s_defaultAttributes.insert(AllowWindowActivationFromJavaScript, false);
+        s_defaultAttributes.insert(PalmServiceBridgeEnabled, false);
+        s_defaultAttributes.insert(LuneOSPrivileged, false);
     }
 
     if (s_defaultFontFamilies.isEmpty()) {
@@ -283,6 +298,8 @@ void WebEngineSettings::initDefaults()
         s_defaultFontSizes.insert(DefaultFontSize, 16);
     }
 
+    m_luneOSIdentifier = "";
+
     m_defaultEncoding = QStringLiteral("ISO-8859-1");
 }
 
@@ -336,6 +353,8 @@ void WebEngineSettings::applySettingsToWebPreferences(content::WebPreferences *p
     prefs->allow_running_insecure_content = testAttribute(AllowRunningInsecureContent);
     prefs->allow_geolocation_on_insecure_origins = testAttribute(AllowGeolocationOnInsecureOrigins);
     prefs->hide_scrollbars = !testAttribute(ShowScrollBars);
+    prefs->luneosPriviledged = testAttribute(LuneOSPrivileged);
+    prefs->luneosAppIdentifier = luneOSIdentifier().toStdString();
 
     // Fonts settings.
     prefs->standard_font_family_map[content::kCommonScript] = toString16(fontFamily(StandardFont));
diff --git a/src/core/web_engine_settings.h b/src/core/web_engine_settings.h
index 1896334..c12f58a 100644
--- a/src/core/web_engine_settings.h
+++ b/src/core/web_engine_settings.h
@@ -85,7 +85,9 @@ public:
         AllowRunningInsecureContent,
         AllowGeolocationOnInsecureOrigins,
         AllowWindowActivationFromJavaScript,
-        ShowScrollBars
+        ShowScrollBars,
+        PalmServiceBridgeEnabled,
+        LuneOSPrivileged
     };
 
     // Must match the values from the public API in qwebenginesettings.h.
@@ -129,6 +131,9 @@ public:
     void setDefaultTextEncoding(const QString &encoding);
     QString defaultTextEncoding() const;
 
+    void setLuneOSIdentifier(const QString &identifier);
+    QString luneOSIdentifier() const;
+
     void initDefaults();
     void scheduleApply();
 
@@ -146,6 +151,7 @@ private:
     QHash<FontFamily, QString> m_fontFamilies;
     QHash<FontSize, int> m_fontSizes;
     QString m_defaultEncoding;
+    QString m_luneOSIdentifier;
     QScopedPointer<content::WebPreferences> webPreferences;
     QScopedPointer<BatchTimer> m_batchTimer;
 
diff --git a/src/webengine/api/qquickwebenginesettings.cpp b/src/webengine/api/qquickwebenginesettings.cpp
index 3ce5333..a5b7004 100644
--- a/src/webengine/api/qquickwebenginesettings.cpp
+++ b/src/webengine/api/qquickwebenginesettings.cpp
@@ -395,6 +395,21 @@ QString QQuickWebEngineSettings::defaultTextEncoding() const
     return d_ptr->defaultTextEncoding();
 }
 
+bool QQuickWebEngineSettings::palmServiceBridgeEnabled() const
+{
+    return d_ptr->testAttribute(WebEngineSettings::PalmServiceBridgeEnabled);
+}
+
+bool QQuickWebEngineSettings::luneOSPrivileged() const
+{
+    return d_ptr->testAttribute(WebEngineSettings::LuneOSPrivileged);
+}
+
+QString QQuickWebEngineSettings::luneOSIdentifier() const
+{
+    return d_ptr->luneOSIdentifier();
+}
+
 void QQuickWebEngineSettings::setAutoLoadImages(bool on)
 {
     bool wasOn = d_ptr->testAttribute(WebEngineSettings::AutoLoadImages);
@@ -598,6 +613,29 @@ void QQuickWebEngineSettings::setShowScrollBars(bool on)
     if (wasOn != on)
         Q_EMIT showScrollBarsChanged();
 }
+void QQuickWebEngineSettings::setPalmServiceBridgeEnabled(bool on)
+{
+    bool wasOn = d_ptr->testAttribute(WebEngineSettings::PalmServiceBridgeEnabled);
+    d_ptr->setAttribute(WebEngineSettings::PalmServiceBridgeEnabled, on);
+    if (wasOn != on)
+        Q_EMIT palmServiceBridgeEnabledChanged();
+}
+
+void QQuickWebEngineSettings::setLuneOSPrivileged(bool on)
+{
+    bool wasOn = d_ptr->testAttribute(WebEngineSettings::LuneOSPrivileged);
+    d_ptr->setAttribute(WebEngineSettings::LuneOSPrivileged, on);
+    if (wasOn != on)
+        Q_EMIT luneOSPrivilegedChanged();
+}
+
+void QQuickWebEngineSettings::setLuneOSIdentifier(QString identifier)
+{
+    const QString oldLuneOSIdentifier = d_ptr->luneOSIdentifier();
+    d_ptr->setLuneOSIdentifier(identifier);
+    if (oldLuneOSIdentifier.compare(identifier))
+        Q_EMIT luneOSIdentifierChanged();
+}
 
 void QQuickWebEngineSettings::setParentSettings(QQuickWebEngineSettings *parentSettings)
 {
diff --git a/src/webengine/api/qquickwebenginesettings_p.h b/src/webengine/api/qquickwebenginesettings_p.h
index a8b11c7..6ed2af0 100644
--- a/src/webengine/api/qquickwebenginesettings_p.h
+++ b/src/webengine/api/qquickwebenginesettings_p.h
@@ -88,6 +88,9 @@ class Q_WEBENGINE_PRIVATE_EXPORT QQuickWebEngineSettings : public QObject {
     Q_PROPERTY(bool allowGeolocationOnInsecureOrigins READ allowGeolocationOnInsecureOrigins WRITE setAllowGeolocationOnInsecureOrigins NOTIFY allowGeolocationOnInsecureOriginsChanged REVISION 4 FINAL)
     Q_PROPERTY(bool allowWindowActivationFromJavaScript READ allowWindowActivationFromJavaScript WRITE setAllowWindowActivationFromJavaScript NOTIFY allowWindowActivationFromJavaScriptChanged REVISION 5 FINAL)
     Q_PROPERTY(bool showScrollBars READ showScrollBars WRITE setShowScrollBars NOTIFY showScrollBarsChanged REVISION 5 FINAL)
+    Q_PROPERTY(bool palmServiceBridgeEnabled READ palmServiceBridgeEnabled WRITE setPalmServiceBridgeEnabled NOTIFY palmServiceBridgeEnabledChanged)
+    Q_PROPERTY(bool luneOSPrivileged READ luneOSPrivileged WRITE setLuneOSPrivileged NOTIFY luneOSPrivilegedChanged)
+    Q_PROPERTY(QString luneOSIdentifier READ luneOSIdentifier WRITE setLuneOSIdentifier NOTIFY luneOSIdentifierChanged)
 
 public:
     ~QQuickWebEngineSettings();
@@ -117,6 +120,9 @@ public:
     bool allowGeolocationOnInsecureOrigins() const;
     bool allowWindowActivationFromJavaScript() const;
     bool showScrollBars() const;
+    bool palmServiceBridgeEnabled() const;
+    bool luneOSPrivileged() const;
+    QString luneOSIdentifier() const;
 
     void setAutoLoadImages(bool on);
     void setJavascriptEnabled(bool on);
@@ -143,6 +149,9 @@ public:
     void setAllowGeolocationOnInsecureOrigins(bool on);
     void setAllowWindowActivationFromJavaScript(bool on);
     void setShowScrollBars(bool on);
+    void setPalmServiceBridgeEnabled(bool on);
+    void setLuneOSPrivileged(bool on);
+    void setLuneOSIdentifier(QString identifier);
 
 signals:
     void autoLoadImagesChanged();
@@ -170,6 +179,9 @@ signals:
     Q_REVISION(4) void allowGeolocationOnInsecureOriginsChanged();
     Q_REVISION(5) void allowWindowActivationFromJavaScriptChanged();
     Q_REVISION(5) void showScrollBarsChanged();
+    void palmServiceBridgeEnabledChanged();
+    void luneOSPrivilegedChanged();
+    void luneOSIdentifierChanged();
 
 private:
     explicit QQuickWebEngineSettings(QQuickWebEngineSettings *parentSettings = 0);
